name: CI/CD with Telegram Notification

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Get commit information
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s' | sed 's/[_*\[\]()~`>#\+=|{}.!]/\\&/g')
          COMMIT_DATE=$(git log -1 --pretty=format:'%ci')
          BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
          REPO_NAME=${{ github.repository }}
          COMMIT_URL="https://github.com/$REPO_NAME/commit/$COMMIT_HASH"
          GITHUB_ACTOR="${{ github.actor }}"

          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$COMMIT_MESSAGE" >> $GITHUB_ENV
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
          echo "COMMIT_URL=$COMMIT_URL" >> $GITHUB_ENV
          echo "GITHUB_ACTOR=$GITHUB_ACTOR" >> $GITHUB_ENV

      - name: Serverga ulanish va pull qilish
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            sudo -i << 'EOF'
            cd /var/www/palermo_front

            # Git konfiguratsiyasi

            # Konflikt boâ€˜lsa, eski kodlarni inkor qilish
            git fetch origin main
            git reset --hard origin/main

            # Virtual muhitni faollashtirish va yangilash
            npm install
            npm run build
            pm2 restart all
            systemctl restart nginx
            EOF

      - name: Send notification to Telegram
        run: |
            curl -X POST "https://api.telegram.org/bot7399847827:AAG5tD_qQU8qIktxVMRMkHoWZENLRU9HnQ4/sendMessage" \
            -d "chat_id=-1002289045305" \
            -d "parse_mode=MarkdownV2" \
            -d "text=*ðŸ“¢ Palermo Frontend Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½\!*%0A
            ðŸ“Œ *ÐÐ²Ñ‚Ð¾Ñ€:* \`${{ env.GITHUB_ACTOR }}\`%0A%0A
            ðŸŒ¿ *Ð’ÐµÑ‚ÐºÐ°:* \`${{ env.BRANCH_NAME }}\`%0A%0A
            ðŸ“ *Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°:* \`${{ env.COMMIT_MESSAGE }}\`%0A%0A
            ðŸ“… *Ð”Ð°Ñ‚Ð°:* \`${{ env.COMMIT_DATE }}\`%0A%0A
            ðŸ”— [ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°](${{ env.COMMIT_URL }})%0A%0A
            âœ… *ÐšÐ¾Ð´ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½ Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ*%0A%0A
            ðŸ”— [ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ ÑÐ°Ð¹Ñ‚](https://palermo.divspan.uz/)%0A%0A
            ðŸ”— [ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ](https://github.com/${{ github.repository }})"

